name: Validate & format website (validate-website.pl)

on:
  push:
    paths:
      - "**/*.html"
      - "**/*.htm"
      - "**/*.xml"
      - "**/*.svg"
      - "**/*.css"
      - "**/*.js"
      - "**/*.mjs"
      - "**/*.cjs"
      - "scripts/validate-website.pl"
  pull_request:
    paths:
      - "**/*.html"
      - "**/*.htm"
      - "**/*.xml"
      - "**/*.svg"
      - "**/*.css"
      - "**/*.js"
      - "**/*.mjs"
      - "**/*.cjs"
      - "scripts/validate-website.pl"

permissions:
  contents: write

jobs:
  validate_website:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout (push)
        if: github.event_name == 'push'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout (pull_request HEAD)
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Detect file types in repo
        id: detect
        run: |
          set -euo pipefail

          has_html=false
          has_xml=false
          has_svg=false
          has_css=false
          has_js=false

          git ls-files | grep -E '\.(html|htm)$' -m1 >/dev/null 2>&1 && has_html=true || true
          git ls-files | grep -E '\.xml$' -m1 >/dev/null 2>&1 && has_xml=true || true
          git ls-files | grep -E '\.svg$' -m1 >/dev/null 2>&1 && has_svg=true || true
          git ls-files | grep -E '\.css$' -m1 >/dev/null 2>&1 && has_css=true || true
          git ls-files | grep -E '\.(js|mjs|cjs)$' -m1 >/dev/null 2>&1 && has_js=true || true

          echo "has_html=$has_html" >> "$GITHUB_OUTPUT"
          echo "has_xml=$has_xml" >> "$GITHUB_OUTPUT"
          echo "has_svg=$has_svg" >> "$GITHUB_OUTPUT"
          echo "has_css=$has_css" >> "$GITHUB_OUTPUT"
          echo "has_js=$has_js" >> "$GITHUB_OUTPUT"

          echo "Detected: html=$has_html xml=$has_xml svg=$has_svg css=$has_css js=$has_js"

      - name: Install minimal apt dependencies (only if missing)
        run: |
          set -euo pipefail

          pkgs=()

          if [[ "${{ steps.detect.outputs.has_html }}" == "true" ]]; then
            command -v tidy >/dev/null 2>&1 || pkgs+=(tidy)
            command -v java >/dev/null 2>&1 || pkgs+=(default-jre-headless)
          fi

          if [[ "${{ steps.detect.outputs.has_xml }}" == "true" || "${{ steps.detect.outputs.has_svg }}" == "true" ]]; then
            command -v xmllint >/dev/null 2>&1 || pkgs+=(libxml2-utils)
          fi

          if [[ "${#pkgs[@]}" -gt 0 ]]; then
            sudo apt-get update
            sudo apt-get install -y "${pkgs[@]}"
          fi

          if [[ "${{ steps.detect.outputs.has_html }}" == "true" ]]; then
            tidy -version
            java -version
          fi
          if [[ "${{ steps.detect.outputs.has_xml }}" == "true" || "${{ steps.detect.outputs.has_svg }}" == "true" ]]; then
            xmllint --version | head -n 1
          fi

      - name: Setup Node.js (only if CSS/JS exist)
        if: steps.detect.outputs.has_css == 'true' || steps.detect.outputs.has_js == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Install minimal Node tools (only what script requires)
        if: steps.detect.outputs.has_css == 'true' || steps.detect.outputs.has_js == 'true'
        run: |
          set -euo pipefail

          # Install into user prefix (no sudo)
          mkdir -p "$HOME/.local"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

          need=0
          command -v prettier >/dev/null 2>&1 || need=1
          command -v eslint >/dev/null 2>&1 || need=1
          command -v stylelint >/dev/null 2>&1 || need=1

          if [[ "$need" -eq 1 ]]; then
            npm config set fund false
            npm config set audit false
            npm install -g --prefix "$HOME/.local" prettier eslint stylelint
          fi

          prettier --version
          eslint --version
          stylelint --version

      - name: Download vnu.jar (only if HTML exists)
        if: steps.detect.outputs.has_html == 'true'
        run: |
          set -euo pipefail
          command -v curl >/dev/null 2>&1 || { echo "curl missing"; exit 1; }
          curl -fsSL -o /tmp/vnu.jar https://github.com/validator/validator/releases/download/latest/vnu.jar
          test -s /tmp/vnu.jar
          ls -lh /tmp/vnu.jar

      - name: Run validate-website.pl (format + validate)
        env:
          VNU_JAR: /tmp/vnu.jar
        run: |
          set -euo pipefail
          perl ./scripts/validate-website.pl --apply

      - name: Commit & push changes (push event)
        if: github.event_name == 'push'
        run: |
          set -euo pipefail
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "chore: format website files"
            git push
          else
            echo "No changes to commit."
          fi

      - name: Commit & push changes (PR from same repo)
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        run: |
          set -euo pipefail
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "chore: format website files"
            git push origin HEAD:${{ github.head_ref }}
          else
            echo "No changes to commit."
          fi

      - name: Fail if formatting changed files (PR from fork cannot be pushed)
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name != github.repository
        run: |
          set -euo pipefail
          if [ -n "$(git status --porcelain)" ]; then
            echo "PR from fork: cannot push changes back. Run the formatter locally and commit."
            git diff
            exit 1
          fi
            echo "No formatting changes detected."

name: Validate & format website (validate-website.pl)

on:
  push:
    paths:
      - "**/*.html"
      - "**/*.htm"
      - "**/*.xml"
      - "**/*.svg"
      - "**/*.css"
      - "**/*.js"
      - "**/*.mjs"
      - "**/*.cjs"
      - "**/*.json"
      - "scripts/validate-website.pl"
      - ".github/workflows/validate-website.yml"
  pull_request:
    paths:
      - "**/*.html"
      - "**/*.htm"
      - "**/*.xml"
      - "**/*.svg"
      - "**/*.css"
      - "**/*.js"
      - "**/*.mjs"
      - "**/*.cjs"
      - "**/*.json"
      - "scripts/validate-website.pl"
      - ".github/workflows/validate-website.yml"

permissions:
  contents: write

jobs:
  validate_website:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout (push)
        if: github.event_name == 'push'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout (pull_request HEAD)
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Detect file types in repo
        id: detect
        run: |
          set -euo pipefail

          has_html=false
          has_xml=false
          has_svg=false
          has_css=false
          has_js=false
          has_json=false

          git ls-files | grep -E '\.(html|htm)$' -m1 >/dev/null 2>&1 && has_html=true || true
          git ls-files | grep -E '\.xml$' -m1 >/dev/null 2>&1 && has_xml=true || true
          git ls-files | grep -E '\.svg$' -m1 >/dev/null 2>&1 && has_svg=true || true
          git ls-files | grep -E '\.css$' -m1 >/dev/null 2>&1 && has_css=true || true
          git ls-files | grep -E '\.(js|mjs|cjs)$' -m1 >/dev/null 2>&1 && has_js=true || true
          git ls-files | grep -E '\.json$' -m1 >/dev/null 2>&1 && has_json=true || true

          echo "has_html=$has_html" >> "$GITHUB_OUTPUT"
          echo "has_xml=$has_xml" >> "$GITHUB_OUTPUT"
          echo "has_svg=$has_svg" >> "$GITHUB_OUTPUT"
          echo "has_css=$has_css" >> "$GITHUB_OUTPUT"
          echo "has_js=$has_js" >> "$GITHUB_OUTPUT"
          echo "has_json=$has_json" >> "$GITHUB_OUTPUT"

          echo "Detected: html=$has_html xml=$has_xml svg=$has_svg css=$has_css js=$has_js"

      - name: Install minimal apt dependencies
        run: |
          set -euo pipefail

          pkgs=()
          pkgs+=(perl)

          if [[ "${{ steps.detect.outputs.has_html }}" == "true" ]]; then
            pkgs+=(tidy)
          fi

          if [[ "${{ steps.detect.outputs.has_xml }}" == "true" || "${{ steps.detect.outputs.has_svg }}" == "true" ]]; then
            pkgs+=(libxml2-utils)
          fi

          if [[ "${{ steps.detect.outputs.has_css }}" == "true" || "${{ steps.detect.outputs.has_js }}" == "true" ]]; then
            pkgs+=(curl unzip)
          fi

          if [[ "${{ steps.detect.outputs.has_json }}" == "true" ]]; then
            pkgs+=(jq)
          fi

          sudo apt-get update
          sudo apt-get install -y "${pkgs[@]}"

          tidy -version || true
          xmllint --version | head -n 1 || true
          perl -v | head -n 2 || true

      - name: Install dprint (only if CSS/JS exist)
        if: steps.detect.outputs.has_css == 'true' || steps.detect.outputs.has_js == 'true'
        run: |
          set -euo pipefail

          # Install into user prefix (no sudo)
          mkdir -p "$HOME/.local/bin"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

          # Try the official install script first; if it's unavailable (404),
          # fall back to selecting an asset from the GitHub releases API.
          tmp_script="/tmp/dprint-install.sh"
          if curl -fLsS --retry 5 https://dprint.dev/install.sh -o "$tmp_script"; then
            bash "$tmp_script" --dir "$HOME/.local/bin"
          else
            echo "Official install script not available; falling back to GitHub release"
            OS=$(uname -s)
            ARCH=$(uname -m)

            case "$ARCH" in
              x86_64|amd64) arch="x86_64" ;;
              aarch64|arm64) arch="aarch64" ;;
              *) arch="$ARCH" ;;
            esac

            # Query GitHub API for latest release and pick a matching tar.gz asset
            api_json=$(curl -fsS --retry 5 "https://api.github.com/repos/dprint/dprint/releases/latest" || true)
            download_url=""
            if [ -n "$api_json" ]; then
              download_url=$(printf '%s' "$api_json" \
                | grep '"browser_download_url":' \
                | sed -E 's/.*"([^\"]+)".*/\1/' \
                | grep -E '\.tar\.gz$' \
                | grep -i "$arch" || true)
            fi

            # If no match found by arch, fallback to any linux tarball
            if [ -z "$download_url" ]; then
              download_url=$(printf '%s' "$api_json" \
                | grep '"browser_download_url":' \
                | sed -E 's/.*"([^\"]+)".*/\1/' \
                | grep -i linux \
                | grep -E '\.tar\.gz$' \
                | head -n1 || true)
            fi

            if [ -z "$download_url" ]; then
              echo "Could not determine a dprint release asset to download." >&2
              exit 1
            fi

            echo "Downloading dprint from: $download_url"
            curl -fLsS --retry 5 "$download_url" -o /tmp/dprint.tar.gz
            tar -xzf /tmp/dprint.tar.gz -C /tmp
            # Find the extracted dprint binary
            binpath=$(find /tmp -maxdepth 3 -type f -name dprint -perm /u+x -print -quit || true)
            if [ -z "$binpath" ]; then
              echo "dprint binary not found inside archive" >&2
              exit 1
            fi
            mv "$binpath" "$HOME/.local/bin/dprint"
            chmod +x "$HOME/.local/bin/dprint"
          fi

          dprint --version

      - name: Run validate-website.pl (format + validate)
        run: |
          set -euo pipefail
          perl ./scripts/validate-website.pl --apply

      - name: Commit & push changes (push event)
        if: github.event_name == 'push'
        run: |
          set -euo pipefail
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "chore: format website files"
            git push
          else
            echo "No changes to commit."
          fi

      - name: Commit & push changes (PR from same repo)
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        run: |
          set -euo pipefail
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "chore: format website files"
            git push origin HEAD:${{ github.head_ref }}
          else
            echo "No changes to commit."
          fi

      - name: Fail if formatting changed files (PR from fork cannot be pushed)
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name != github.repository
        run: |
          set -euo pipefail
          if [ -n "$(git status --porcelain)" ]; then
            echo "PR from fork: cannot push changes back. Run the formatter locally and commit."
            git diff
            exit 1
          fi
          echo "No formatting changes detected."


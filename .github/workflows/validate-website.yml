name: Validate & format website (validate-website.pl)

on:
  push:
    paths:
      - "**/*.html"
      - "**/*.htm"
      - "**/*.xml"
      - "**/*.svg"
      - "**/*.css"
      - "**/*.js"
      - "**/*.mjs"
      - "**/*.cjs"
      - "**/*.json"
      - "scripts/validate-website.pl"
      - ".github/workflows/validate-website.yml"
  pull_request:
    paths:
      - "**/*.html"
      - "**/*.htm"
      - "**/*.xml"
      - "**/*.svg"
      - "**/*.css"
      - "**/*.js"
      - "**/*.mjs"
      - "**/*.cjs"
      - "**/*.json"
      - "scripts/validate-website.pl"
      - ".github/workflows/validate-website.yml"
  # Allow manual runs from the Actions tab
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  validate_website:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout (push)
        if: github.event_name == 'push'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout (pull_request HEAD)
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Detect file types in repo
        id: detect
        run: |
          set -euo pipefail

          has_html=false
          has_xml=false
          has_svg=false
          has_css=false
          has_js=false
          has_json=false

          git ls-files | grep -E '\.(html|htm)$' -m1 >/dev/null 2>&1 && has_html=true || true
          git ls-files | grep -E '\.xml$' -m1 >/dev/null 2>&1 && has_xml=true || true
          git ls-files | grep -E '\.svg$' -m1 >/dev/null 2>&1 && has_svg=true || true
          git ls-files | grep -E '\.css$' -m1 >/dev/null 2>&1 && has_css=true || true
          git ls-files | grep -E '\.(js|mjs|cjs)$' -m1 >/dev/null 2>&1 && has_js=true || true
          git ls-files | grep -E '\.json$' -m1 >/dev/null 2>&1 && has_json=true || true

          echo "has_html=$has_html" >> "$GITHUB_OUTPUT"
          echo "has_xml=$has_xml" >> "$GITHUB_OUTPUT"
          echo "has_svg=$has_svg" >> "$GITHUB_OUTPUT"
          echo "has_css=$has_css" >> "$GITHUB_OUTPUT"
          echo "has_js=$has_js" >> "$GITHUB_OUTPUT"
          echo "has_json=$has_json" >> "$GITHUB_OUTPUT"

          echo "Detected: html=$has_html xml=$has_xml svg=$has_svg css=$has_css js=$has_js"

      - name: Install minimal apt dependencies
        run: |
          set -euo pipefail

          pkgs=()
          pkgs+=(perl)

          if [[ "${{ steps.detect.outputs.has_html }}" == "true" ]]; then
            pkgs+=(tidy)
          fi

          if [[ "${{ steps.detect.outputs.has_xml }}" == "true" || "${{ steps.detect.outputs.has_svg }}" == "true" ]]; then
            pkgs+=(libxml2-utils)
          fi

          if [[ "${{ steps.detect.outputs.has_css }}" == "true" || "${{ steps.detect.outputs.has_js }}" == "true" ]]; then
            pkgs+=(curl unzip)
          fi

          if [[ "${{ steps.detect.outputs.has_json }}" == "true" ]]; then
            pkgs+=(jq)
          fi

          sudo apt-get update
          sudo apt-get install -y "${pkgs[@]}"

          tidy -version || true
          xmllint --version | head -n 1 || true
          perl -v | head -n 2 || true

      - name: Install dprint (only if CSS/JS exist)
        if: steps.detect.outputs.has_css == 'true' || steps.detect.outputs.has_js == 'true'
        run: |
          set -euo pipefail

          # Install Rust toolchain (non-interactive) so we can use `cargo`
          curl -sSf https://sh.rustup.rs -o /tmp/rustup.sh
          chmod +x /tmp/rustup.sh
          RUSTUP_HOME="$HOME/.rustup" CARGO_HOME="$HOME/.cargo" sh /tmp/rustup.sh -y --no-modify-path

          # Ensure cargo in PATH for the rest of the job
          echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
          export PATH="$HOME/.cargo/bin:$PATH"

          cargo --version || true

          # Install dprint via cargo.
          cargo install dprint --locked || true

          # Ensure any cargo-installed binaries are available
          echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"

          dprint --version || true

      - name: Run validate-website.pl (format + validate)
        run: |
          set -euo pipefail
          perl ./scripts/validate-website.pl --apply

      - name: Commit & push changes (push event)
        if: github.event_name == 'push'
        run: |
          set -euo pipefail
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "Format website files"
            git push
          else
            echo "No changes to commit."
          fi

      - name: Commit & push changes (PR from same repo)
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        run: |
          set -euo pipefail
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "Format website files"
            git push origin HEAD:${{ github.head_ref }}
          else
            echo "No changes to commit."
          fi

      - name: Fail if formatting changed files (PR from fork cannot be pushed)
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name != github.repository
        run: |
          set -euo pipefail
          if [ -n "$(git status --porcelain)" ]; then
            echo "PR from fork: cannot push changes back. Run the formatter locally and commit."
            git diff
            exit 1
          fi
          echo "No formatting changes detected."

name: Archive website (pax + gzip + signify)

on:
  schedule:
    - cron: '0 0 * * *'   # Once per day at 00:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  archive:
    runs-on: ubuntu-latest
    name: Archive website on OpenBSD

    env:
      GH_TOKEN: ${{ github.token }}
      SIGNIFY_KEY: ${{ secrets.SIGNIFY_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run archive job in OpenBSD
        uses: vmactions/openbsd-vm@v1
        with:
          usesh: false
          envs: 'GH_TOKEN SIGNIFY_KEY'
          sync: rsync
          copyback: false
          prepare: |
            pkg_add -I git rsync github-cli gzip

          run: |
            set -e

            echo "Running on:"
            uname -a

            # Repo info
            REPO_NAME=$(basename "$GITHUB_REPOSITORY")
            ARCHIVE_DIR=archive
            TMP_DIR=/tmp/archive

            mkdir -p "$TMP_DIR" "$ARCHIVE_DIR"

            ARCHIVE="$TMP_DIR/$REPO_NAME.tar.gz"
            CHECKSUM="$TMP_DIR/$REPO_NAME.tar.gz.sha256"
            SIGNATURE="$TMP_DIR/$REPO_NAME.tar.gz.sig"

            rm -f "$ARCHIVE" "$CHECKSUM" "$SIGNATURE"

            # Create archive
            pax -w -x tar . | gzip -n -9 > "$ARCHIVE"

            # Checksum
            sha256 -q "$ARCHIVE" > "$CHECKSUM"

            # Write signify key (no passphrase)
            printf "%s\n" "$SIGNIFY_KEY" > /root/archive.sec
            chmod 600 /root/archive.sec

            # Sign archive
            signify -S -s /root/archive.sec -m "$ARCHIVE"

            # Replace archive directory contents
            rsync -av --delete "$TMP_DIR/" "$ARCHIVE_DIR/"

            # Git config
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            # Commit changes
            git add archive/
            git commit -m "Archive website (OpenBSD) [skip ci]" || exit 0

            # Authenticate with GitHub CLI
            echo "$GH_TOKEN" | gh auth login --with-token

            # Push changes
            git push origin main

name: Archive website (pax + gzip + signify)

on:
  schedule:
    - cron: '0 0 * * *'  # Runs once a day at 00:00 UTC
  workflow_dispatch:

jobs:
  openbsd-ci:
    runs-on: ubuntu-latest
    name: Run CI on OpenBSD VM
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      SIGNIFY_KEY: ${{ secrets.SIGNIFY_KEY }}
    steps:
      - uses: actions/checkout@v4

      - name: Run OpenBSD VM
        id: openbsd
        uses: vmactions/openbsd-vm@v1
        with:
          envs: 'GH_TOKEN SIGNIFY_KEY'
          usesh: true
          prepare: |
            pkg_add -I tree curl rsync git github-cli

      - name: Create Archive, Checksum, and Signature
        shell: openbsd {0}
        run: |
          set -e
          REPO_NAME=$(basename $GITHUB_REPOSITORY)
          TMP_ARCHIVE_DIR=/tmp/archive
          mkdir -p "$TMP_ARCHIVE_DIR"
          ARCHIVE="$TMP_ARCHIVE_DIR/$REPO_NAME.tar.gz"
          CHECKSUM="$TMP_ARCHIVE_DIR/$REPO_NAME.tar.gz.sha256"
          SIGNATURE="$TMP_ARCHIVE_DIR/$REPO_NAME.tar.gz.sig"

          # Remove old files
          rm -f "$ARCHIVE" "$CHECKSUM" "$SIGNATURE"

          # Create tar.gz excluding archive folder
          pax -w -x tar -s '/^\.\///' -s '/^archive//' . | gzip -n -9 > "$ARCHIVE"

          # Generate SHA256 checksum
          sha256 -q "$ARCHIVE" > "$CHECKSUM"

          # Decode signify key and sign archive
          echo "$SIGNIFY_KEY" | openssl base64 -d > /root/archive.sec
          chmod 600 /root/archive.sec
          signify -S -s /root/archive.sec -m "$ARCHIVE"

      - name: Sync Archive Back
        shell: openbsd {0}
        run: |
          mkdir -p archive
          rsync -av --delete /tmp/archive "$GITHUB_WORKSPACE/"

      - name: Commit and Push Changes
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add archive/
          git commit -m "Update archive from OpenBSD CI [skip ci]" || echo "No changes to commit"
          gh auth login --with-token <<< "$GH_TOKEN"
          gh repo clone $GITHUB_REPOSITORY repo-push
          cd repo-push
          git pull origin main
          cp -r $GITHUB_WORKSPACE/archive .
          git add archive/
          git commit -m "Archive website" || echo "No changes"
          git push origin main

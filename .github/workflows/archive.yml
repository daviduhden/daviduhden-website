name: Archive website (LFS + history cleanup)

on:
  schedule:
    - cron: '0 0 * * *'   # Daily at midnight UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  archive:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      SIGNIFY_KEY: ${{ secrets.SIGNIFY_KEY }}

    steps:
      # ----------------------------
      # Checkout repository with full history and LFS
      # ----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      # ----------------------------
      # Install dependencies
      # ----------------------------
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip signify-openbsd
          pip3 install --upgrade git-filter-repo

      # ----------------------------
      # Create archive, checksum, and signature
      # ----------------------------
      - name: Create Archive, Checksum, and Signature
        run: |
          set -euo pipefail

          REPO_NAME=$(basename "$GITHUB_REPOSITORY")
          ARCHIVE_DIR="$GITHUB_WORKSPACE/archive"
          TMP_DIR="$GITHUB_WORKSPACE/tmp_archive"

          mkdir -p "$ARCHIVE_DIR" "$TMP_DIR"

          ARCHIVE="$TMP_DIR/$REPO_NAME.tar.gz"
          CHECKSUM="$TMP_DIR/$REPO_NAME.tar.gz.sha256"
          SIGNATURE="$TMP_DIR/$REPO_NAME.tar.gz.sig"

          rm -f "$ARCHIVE" "$CHECKSUM" "$SIGNATURE"

          # Create tar.gz archive in PAX format
          tar --format=pax --exclude="tmp_archive" -czf "$ARCHIVE" .

          # Generate SHA256 checksum
          sha256sum "$ARCHIVE" > "$CHECKSUM"

          # Write SIGNIFY_KEY to temporary file
          printf "%s\n" "$SIGNIFY_KEY" > "$TMP_DIR/archive.sec"
          chmod 600 "$TMP_DIR/archive.sec"

          # Sign the archive
          signify-openbsd -S -s "$TMP_DIR/archive.sec" -m "$ARCHIVE"

      # ----------------------------
      # Track archive file with LFS
      # ----------------------------
      - name: Track Archive with LFS
        run: |
          set -euo pipefail
          git lfs install --local
          git lfs track "archive/*.tar.gz"
          git add .gitattributes

      # ----------------------------
      # Clean old archive files from history
      # ----------------------------
      - name: Clean old archive from history
        run: |
          set -euo pipefail

          REPO_NAME=$(basename "$GITHUB_REPOSITORY")

          # Remove old archive versions from history
          git filter-repo --path "archive/$REPO_NAME.tar.gz" --invert-paths --force

          # Copy the newly generated archive, checksum, and signature into the repo
          cp "$GITHUB_WORKSPACE/tmp_archive/$REPO_NAME.tar.gz" "$GITHUB_WORKSPACE/archive/"
          cp "$GITHUB_WORKSPACE/tmp_archive/$REPO_NAME.tar.gz.sha256" "$GITHUB_WORKSPACE/archive/"
          cp "$GITHUB_WORKSPACE/tmp_archive/$REPO_NAME.tar.gz.sig" "$GITHUB_WORKSPACE/archive/"

          # Add the new files explicitly to Git
          git add "archive/$REPO_NAME.tar.gz"
          git add "archive/$REPO_NAME.tar.gz.sha256"
          git add "archive/$REPO_NAME.tar.gz.sig"

      # ----------------------------
      # Commit and push changes
      # ----------------------------
      - name: Commit and Push
        run: |
          set -euo pipefail

          REPO_NAME=$(basename "$GITHUB_REPOSITORY")

          # Re-add origin remote (required after git-filter-repo)
          git remote add origin https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git

          # Configure Git for Actions
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Commit only if there are changes
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "Archive website (updated $(date -u +"%Y-%m-%d"))"
            git push --force origin main
          else
            echo "No changes to commit."
          fi

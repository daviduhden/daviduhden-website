name: Archive website

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  archive:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      REPO: ${{ github.repository }}
      VM_SSH_USER: runner
      VM_SSH_HOST: 127.0.0.1
      VM_SSH_PORT: 2224
      VM_REPO_DIR: /home/runner/work/${{ github.repository }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Generate temporary Ed25519 SSH key
        id: sshkey
        run: |
          ssh-keygen -t ed25519 -f $HOME/temp_ed25519 -N "" -q
          echo "PRIVATE_KEY=$(cat $HOME/temp_ed25519)" >> $GITHUB_ENV
          echo "PUBLIC_KEY=$(cat $HOME/temp_ed25519.pub)" >> $GITHUB_ENV

      - name: Add temporary public key to VM
        run: |
          sshpass -p "$VM_ROOT_PASSWORD" ssh -o StrictHostKeyChecking=no -p $VM_SSH_PORT $VM_SSH_USER@$VM_SSH_HOST \
          "mkdir -p ~/.ssh && echo \"$PUBLIC_KEY\" >> ~/.ssh/authorized_keys"

      - name: Prepare VM repository
        run: |
          mkdir -p ~/.ssh
          echo "$PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p $VM_SSH_PORT $VM_SSH_HOST >> ~/.ssh/known_hosts

          ssh -p $VM_SSH_PORT $VM_SSH_USER@$VM_SSH_HOST bash -c "'
            cd $VM_REPO_DIR || exit 1
            git init 2>/dev/null || true
            git remote add origin https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git 2>/dev/null || true
            git config user.name \"github-actions[bot]\"
            git config user.email \"github-actions[bot]@users.noreply.github.com\"
          '"

      - name: Create archive using pax + gzip
        run: |
          pax -w -p e archive | gzip > archive.tar.gz

      - name: Sync archive to VM and commit
        run: |
          scp -P $VM_SSH_PORT archive.tar.gz $VM_SSH_USER@$VM_SSH_HOST:$VM_REPO_DIR/
          ssh -p $VM_SSH_PORT $VM_SSH_USER@$VM_SSH_HOST bash -c "'
            cd $VM_REPO_DIR
            gzip -dc archive.tar.gz | pax -r -p e
            rm archive.tar.gz
            git add archive/
            git commit -m \"Archive website [skip ci]\" || echo \"Nothing to commit\"
            GIT_CURL_VERBOSE=1 GIT_TRACE=1 git push origin main || echo \"Push failed or nothing to push\"
          '"

      - name: Remove temporary SSH key from VM
        run: |
          ssh -p $VM_SSH_PORT $VM_SSH_USER@$VM_SSH_HOST \
          "sed -i \"/$(echo $PUBLIC_KEY | sed 's/[\/&]/\\&/g')/d\" ~/.ssh/authorized_keys"

name: Archive website (pax + gzip + signify)

on:
  schedule:
    - cron: '0 0 * * *'  # Runs once a day at 00:00 UTC
  workflow_dispatch:

jobs:
  openbsd-archive:
    runs-on: ubuntu-latest
    name: Run OpenBSD VM to create archive
    env:
      SIGNIFY_KEY: ${{ secrets.SIGNIFY_KEY }}  # base64-encoded signify key
      GH_TOKEN: ${{ secrets.GH_TOKEN }}        # GitHub token for GH CLI auth
    steps:
      - uses: actions/checkout@v4

      - name: Run OpenBSD VM
        id: vm
        uses: vmactions/openbsd-vm@v1
        with:
          usesh: true
          envs: SIGNIFY_KEY GH_TOKEN
          prepare: |
            pkg_add git github-cli

          run: |
            echo "Running on OpenBSD:"
            uname -a

            REPO_NAME=$(basename $GITHUB_REPOSITORY)
            TMP_ARCHIVE_DIR=/tmp/archive
            mkdir -p "$TMP_ARCHIVE_DIR"
            ARCHIVE="$TMP_ARCHIVE_DIR/$REPO_NAME.tar.gz"
            CHECKSUM="$TMP_ARCHIVE_DIR/$REPO_NAME.tar.gz.sha256"
            SIGNATURE="$TMP_ARCHIVE_DIR/$REPO_NAME.tar.gz.sig"

            # Remove old files
            rm -f "$ARCHIVE" "$CHECKSUM" "$SIGNATURE"

            # Create tar.gz excluding the archive folder
            find . -path './archive' -prune -o -print | pax -w -p e | gzip -n -9 > "$ARCHIVE"

            # Generate SHA256 checksum
            shasum -a 256 "$ARCHIVE" > "$CHECKSUM"

            # Decode and prepare signify key
            echo "$SIGNIFY_KEY" | base64 -d > /root/archive.sec
            chmod 600 /root/archive.sec

            # Sign the archive
            signify -S -s /root/archive.sec -m "$ARCHIVE"

      - name: Copy back files
        run: |
          rsync -av /tmp/archive/ $GITHUB_WORKSPACE/archive/

      - name: Commit and push archive using GitHub CLI
        run: |
          gh auth login --with-token <<< "$GH_TOKEN"
          gh repo clone "$GITHUB_REPOSITORY" repo
          cp -r archive/* repo/archive/
          cd repo
          gh auth setup-git
          git add archive/
          git commit -m "Archive website" || echo "Nothing to commit"
          gh repo sync

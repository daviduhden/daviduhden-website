name: Convert & normalize media (convert-media.pl)

on:
  push:
    paths:
      - "**/*.png"
      - "**/*.jpg"
      - "**/*.jpeg"
      - "**/*.jpe"
      - "**/*.gif"
      - "**/*.bmp"
      - "**/*.tif"
      - "**/*.tiff"
      - "**/*.webp"
      - "**/*.avif"
      - "**/*.heic"
      - "**/*.heif"
      - "**/*.mp3"
      - "**/*.wav"
      - "**/*.flac"
      - "**/*.aac"
      - "**/*.m4a"
      - "**/*.wma"
      - "**/*.mp4"
      - "**/*.m4v"
      - "**/*.mov"
      - "**/*.mkv"
      - "**/*.webm"
      - "**/*.avi"
      - "**/*.mpg"
      - "**/*.mpeg"
      - "**/*.ogg"
      - "**/*.oga"
      - "**/*.ogv"
      - "**/*.opus"
      # references can change even if media doesn't
      - "**/*.html"
      - "**/*.htm"
      - "**/*.xml"
      - "**/*.svg"
      - "**/*.css"
      - "**/*.js"
      - "**/*.mjs"
      - "**/*.cjs"
      - "scripts/convert-media.pl"
  pull_request:
    paths:
      - "**/*.png"
      - "**/*.jpg"
      - "**/*.jpeg"
      - "**/*.jpe"
      - "**/*.gif"
      - "**/*.bmp"
      - "**/*.tif"
      - "**/*.tiff"
      - "**/*.webp"
      - "**/*.avif"
      - "**/*.heic"
      - "**/*.heif"
      - "**/*.mp3"
      - "**/*.wav"
      - "**/*.flac"
      - "**/*.aac"
      - "**/*.m4a"
      - "**/*.wma"
      - "**/*.mp4"
      - "**/*.m4v"
      - "**/*.mov"
      - "**/*.mkv"
      - "**/*.webm"
      - "**/*.avi"
      - "**/*.mpg"
      - "**/*.mpeg"
      - "**/*.ogg"
      - "**/*.oga"
      - "**/*.ogv"
      - "**/*.opus"
      - "**/*.html"
      - "**/*.htm"
      - "**/*.xml"
      - "**/*.svg"
      - "**/*.css"
      - "**/*.js"
      - "**/*.mjs"
      - "**/*.cjs"
      - "scripts/convert-media.pl"

permissions:
  contents: write

jobs:
  convert_media:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout (push)
        if: github.event_name == 'push'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout (pull_request HEAD)
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Detect needs (images/media/embedded URLs)
        id: detect
        run: |
          set -euo pipefail

          has_images=false
          has_media=false
          has_html=false
          has_embeds=false

          git ls-files | grep -E '\.(html|htm)$' -m1 >/dev/null 2>&1 && has_html=true || true

          # Raster images that the script handles (ICO/SVG intentionally excluded)
          git ls-files | grep -E '\.(png|jpe?g|jpe|gif|bmp|tiff?|webp|avif|heic|heif)$' -m1 >/dev/null 2>&1 && has_images=true || true

          # Local media candidates (audio/video)
          git ls-files | grep -E '\.(mp3|wav|flac|aac|m4a|wma|mp4|m4v|mov|mkv|webm|avi|mpg|mpeg|ogg|oga|ogv|opus)$' -m1 >/dev/null 2>&1 && has_media=true || true

          # Remote embedded URLs in HTML (iframe/video/source src="http(s)://...")
          if [[ "$has_html" == "true" ]]; then
            files="$(git ls-files '*.html' '*.htm' || true)"
            if [[ -n "$files" ]]; then
              if echo "$files" | xargs -r grep -I -n -E -i '<(iframe|video|source)[^>]*\bsrc\s*=\s*["'\'']https?://' >/dev/null 2>&1; then
                has_embeds=true
              fi
            fi
          fi

          echo "has_images=$has_images" >> "$GITHUB_OUTPUT"
          echo "has_media=$has_media" >> "$GITHUB_OUTPUT"
          echo "has_embeds=$has_embeds" >> "$GITHUB_OUTPUT"

          echo "Detected: images=$has_images media=$has_media embeds=$has_embeds"

      - name: Install minimal apt dependencies (only if missing)
        run: |
          set -euo pipefail

          pkgs=()

          if [[ "${{ steps.detect.outputs.has_images }}" == "true" ]]; then
            (command -v magick >/dev/null 2>&1 || command -v convert >/dev/null 2>&1) || pkgs+=(imagemagick)
            command -v oxipng >/dev/null 2>&1 || pkgs+=(oxipng)
          fi

          # ffmpeg is required for local media conversion AND for embedded downloads (conversion step)
          if [[ "${{ steps.detect.outputs.has_media }}" == "true" || "${{ steps.detect.outputs.has_embeds }}" == "true" ]]; then
            command -v ffmpeg >/dev/null 2>&1 || pkgs+=(ffmpeg)
          fi

          if [[ "${{ steps.detect.outputs.has_embeds }}" == "true" ]]; then
            command -v yt-dlp >/dev/null 2>&1 || pkgs+=(yt-dlp)
          fi

          if [[ "${#pkgs[@]}" -gt 0 ]]; then
            sudo apt-get update
            sudo apt-get install -y "${pkgs[@]}"
          fi

          # Minimal sanity checks (only print versions for tools we may use)
          if [[ "${{ steps.detect.outputs.has_images }}" == "true" ]]; then
            (magick -version 2>/dev/null || convert -version 2>/dev/null) | head -n 1 || true
            oxipng --version || true
          fi
          if [[ "${{ steps.detect.outputs.has_media }}" == "true" || "${{ steps.detect.outputs.has_embeds }}" == "true" ]]; then
            ffmpeg -version | head -n 1 || true
            ffprobe -version | head -n 1 || true
          fi
          if [[ "${{ steps.detect.outputs.has_embeds }}" == "true" ]]; then
            yt-dlp --version || true
          fi

      - name: Run conversion script (apply)
        env:
          LANG: C.UTF-8
          LC_ALL: C.UTF-8
        run: |
          set -euo pipefail
          perl ./scripts/convert-media.pl --apply --remove-originals

      - name: Commit & push changes (push event)
        if: github.event_name == 'push'
        run: |
          set -euo pipefail
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "chore: normalize media assets"
            git push
          else
            echo "No changes to commit."
          fi

      - name: Commit & push changes (PR from same repo)
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        run: |
          set -euo pipefail
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "chore: normalize media assets"
            git push origin HEAD:${{ github.head_ref }}
          else
            echo "No changes to commit."
          fi

      - name: Fail if changes detected (PR from fork cannot be pushed)
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name != github.repository
        run: |
          set -euo pipefail
          if [ -n "$(git status --porcelain)" ]; then
            echo "PR from fork: cannot push changes back. Run the converter locally and commit."
            git diff
            exit 1
          fi
          echo "No conversion changes detected."
